name: CI

on:
  push:
  pull_request:

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  GO_VERSION: "1.22"

jobs:
  lint-python:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install python tooling
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e sdk/python ruff
      - name: Ruff lint
        run: ruff check sdk/python

  test-python:
    runs-on: ubuntu-latest
    needs: lint-python
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install -e sdk/python pytest pytest-cov coverage
      - name: Python tests
        run: |
          cd sdk/python
          pytest tests --cov=adp_sdk --cov-report=xml:coverage.xml
      - name: Upload Python coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-python
          path: sdk/python/coverage.xml

  test-typescript:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: sdk/typescript/package-lock.json
      - name: Install Node deps
        run: |
          cd sdk/typescript
          npm install
      - name: TypeScript tests
        run: |
          cd sdk/typescript
          npm test -- --silent
      - name: Upload TS coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-ts
          path: sdk/typescript/coverage/lcov.info

  test-rust:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: llvm-tools-preview
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "sdk/rust -> target"
      - name: Install cargo-llvm-cov
        run: |
          cargo install cargo-llvm-cov --locked
      - name: Cargo coverage
        run: |
          cd sdk/rust
          cargo llvm-cov --all-features --locked --lcov --output-path coverage.lcov
      - name: Upload Rust coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-rust
          path: sdk/rust/coverage.lcov

  test-go:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      - name: Go test
        env:
          GOCACHE: ${{ runner.temp }}/gocache
        run: |
          cd sdk/go
          go test ./... -coverprofile=coverage.out -covermode=atomic
      - name: Upload Go coverage
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-go
          path: sdk/go/coverage.out

  validate-schemas:
    runs-on: ubuntu-latest
    needs: [test-python, test-typescript, test-rust, test-go]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"
      - name: Install validation deps
        run: |
          python -m pip install --upgrade pip
          python -m pip install jsonschema pyyaml
      - name: Validate examples and fixtures
        run: ./scripts/validate.sh

  summary:
    runs-on: ubuntu-latest
    needs: [lint-python, test-python, test-typescript, test-rust, test-go, validate-schemas]
    steps:
      - run: echo "All jobs completed."

  upload-coverage:
    runs-on: ubuntu-latest
    needs: [test-python, test-typescript, test-rust, test-go]
    steps:
      - uses: actions/checkout@v4
      - name: Download coverage artifacts
        uses: actions/download-artifact@v4
        with:
          path: coverage-artifacts
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        with:
          files: |
            coverage-artifacts/coverage-python/coverage.xml
            coverage-artifacts/coverage-ts/lcov.info
            coverage-artifacts/coverage-go/coverage.out
            coverage-artifacts/coverage-rust/coverage.lcov
          flags: python,typescript,go,rust
          name: codecov-umbrella
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          verbose: true
