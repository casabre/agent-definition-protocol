adp_version: "0.2.0"
id: "acme.analytics.agent"
name: "Acme Analytics Agent"
description: "Multi-backend agent answering analytics questions with strong governance."
owner: "acme-labs"
tags: ["analytics", "acme", "v0.2.0"]

runtime:
  execution:
    - backend: "docker"
      id: "acme-planner-container"
      image: "acme/agent-planner:1.0.0"
      entrypoint: ["python", "-m", "planner"]
      ports: ["8080:8080"]
      env:
        ACME_LOG_LEVEL: "info"
    - backend: "wasm"
      id: "acme-embedder-wasm"
      module: "embedder.wasm"
      exported_functions: ["embed_text"]
      wasi: true
      memory:
        max_mb: 256
    - backend: "python"
      id: "acme-agent-python"
      source:
        mode: "repo"
        repo: "https://github.com/acme/agent-suite"
        path: "agents/analytics/"
        ref: "v1.1.0"
      entrypoint: "analytics_agent.main:run"
      environment:
        python_version: "3.11"
      dependencies:
        - "langgraph==0.2.1"
    - backend: "typescript"
      id: "acme-tools-ts"
      source:
        mode: "repo"
        repo: "https://github.com/acme/agent-tools-ts"
        path: "src/"
        ref: "tags/v0.3.4"
      package_manager: "npm"
      build_cmd: "npm run build"
      entrypoint: "dist/index.js"
    - backend: "binary"
      id: "acme-metrics-binary"
      path: "bin/acme-metrics"
      args: ["--mode", "fast"]
    - backend: "custom"
      id: "acme-external-endpoint"
      type: "external-http"
      endpoint: "https://api.acme.ai/external-agent/run"

flow:
  id: "acme.analytics.flow"
  graph:
    nodes:
      - id: "input"
        kind: "input"
        ui:
          label: "User Input"
          icon: "message"
      - id: "planner"
        kind: "llm"
        model_ref: "primary"
        system_prompt_ref: "prompts.roles.planner"
        ui:
          label: "ACME Planner"
          icon: "brain"
      - id: "executor"
        kind: "router"
        strategy: "sequence"
      - id: "synthesizer"
        kind: "llm"
        model_ref: "primary"
      - id: "output"
        kind: "output"
        ui:
          label: "Final Answer"
    edges:
      - { from: "input", to: "planner" }
      - { from: "planner", to: "executor" }
      - { from: "executor", to: "synthesizer" }
      - { from: "synthesizer", to: "output" }
    start_nodes: ["input"]
    end_nodes: ["output"]

prompts:
  system: |
    You are the Acme Analytics Agent. Provide concise answers with citations to telemetry sources.
  roles:
    - "planner"
    - "executor"
    - "synthesizer"

skills:
  - id: "answer"
    name: "Answer telemetry questions"
    description: "Provide concise answers using indexed telemetry metrics."
    input_modes: ["text"]
    output_modes: ["text"]
    examples:
      - "What is the p95 latency for service api?"

interop:
  a2a:
    ref: "./docs/agentcard.json"

tools:
  mcp_servers:
    - id: "metrics-mcp"
      description: "Access metrics over MCP"
      transport: "stdio"
      endpoint: "bin/metrics-mcp"
  http_apis:
    - id: "metrics-api"
      description: "REST API for metrics"
      base_url: "https://api.acme.example"
      auth: "Bearer token via env METRICS_TOKEN"
  sql_functions:
    - id: "analytics.fn_latency"
      description: "Returns latency percentiles"
      connection: "postgresql://telemetry:***@db.acme.local:5432/metrics"
      schema: "analytics"

memory:
  provider: "pinecone"
  endpoint: "https://acme-pinecone.example"
  index: "telemetry"
  namespace: "default"

guardrails:
  policies:
    - "https://policies.acme.example/guardrails.json"
  telemetry_endpoint: "https://otel.acme.example/v1"

evaluation:
  suites:
    - id: "acme_groundedness_suite"
      description: "Ensure ACME agent responses are grounded."
      metrics:
        - id: "json_validity"
          type: "deterministic"
          function: "json_schema"
          schema_path: "schemas/acme-output.json"
          threshold: 1.0
        - id: "groundedness"
          type: "llm_judge"
          model: "gpt-4.2"
          system_prompt: |
            You are an evaluator judging groundedness of ACME agent answers...
          rubric:
            - criterion: "Evidence-based reasoning"
              scale: "1-5"
          scoring: "average"
          threshold: 4.0
        - id: "latency"
          type: "telemetry"
          metric: "p95_latency_ms"
          max_ms: 2500
      scoring:
        combine: "weighted_average"
        weights:
          json_validity: 0.3
          groundedness: 0.5
          latency: 0.2
      promotion_threshold: 0.85

kpis:
  - id: "accuracy-core"
    name: "Core accuracy"
    description: "Accuracy across core regression suite"
    url: "https://dash.acme.example/kpi/accuracy-core"
    target: 0.9
    unit: "ratio"

governance:
  identity: "spn:acme-agents/analytics"
  allowed_data_scopes: ["metrics.telemetry", "logs.sanitized"]
  forbidden_data_scopes: ["pii.raw"]
  telemetry_endpoint: "https://otel.acme.example/v1"
  guardrail_policy_set: "./policies/guardrails.json"

deployment:
  environments:
    - name: "dev"
      endpoint: "https://dev.agents.acme.example/analytics"
    - name: "prod"
      endpoint: "https://agents.acme.example/analytics"
